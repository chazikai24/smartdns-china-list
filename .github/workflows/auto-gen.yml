name: Build SmartDNS Conf

on:
  workflow_dispatch:
  schedule:
    - cron: "33 0 * * *"

env:
  REPO_URL: https://github.com/felixonmars/dnsmasq-china-list
  REPO_BRANCH: master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Initialization environment
      run: sudo -E apt -qq update && sudo -E apt -qq install make && sudo mkdir -p /workdir && sudo chown $USER:$GROUPS /workdir

    - name: Clone source code
      run: |
        cd /workdir
        git clone $REPO_URL -b $REPO_BRANCH dnsmasq-china-list --depth 1

    - name: Compile #使用环境白名单模式，全局force-AAAA-SOA yes，下述国内域名开启测速与ipv6
      run: cd /workdir/dnsmasq-china-list && make raw \
            && sed -e "s|\(.*\)|domain-rules /\1/ -speed-check-mode ping,tcp:80,tcp:443 -nameserver domestic -address -6 |" accelerated-domains.china.raw.txt > accelerated-domains.china.domain.smartdns.conf \
            && sed -e "s|\(.*\)|domain-rules /\1/ -speed-check-mode ping,tcp:80,tcp:443 -nameserver domestic -address -6 |" google.china.raw.txt > google.china.domain.smartdns.conf \
            && sed -e "s|\(.*\)|domain-rules /\1/ -speed-check-mode ping,tcp:80,tcp:443 -nameserver domestic -address -6 |" apple.china.raw.txt > apple.china.domain.smartdns.conf 
            
    - name: Compile apple_domains
      run: cd /workdir/dnsmasq-china-list && wget -qO- https://raw.githubusercontent.com/Loyalsoldier/domain-list-custom/refs/heads/release/apple.txt | grep -Ev "^#|^$" | sed -E 's/^(full:|domain:|keyword:|regexp:)//' | awk -F '@' '{print $1}' | sort -u > apple_domains.txt && sed -e "s|\(.*\)|domain-rules /\1/ -speed-check-mode tcp:80 -nameserver domestic |" apple_domains.txt > apple.domain.smartdns.conf

    - name: Compile apple_china_domains from DustinWin/ruleset_geodata
      run: cd /workdir/dnsmasq-china-list && wget -qO- https://raw.githubusercontent.com/DustinWin/ruleset_geodata/refs/heads/mihomo-ruleset/apple-cn.list | sed -E "s/^[[:space:]]*[-+ .]*//; s/['\"]//g; /^[[:space:]]*$/d; /^#/d" | sort -u > apple_china.domains.txt && sed -e "s|\(.*\)|domain-rules /\1/ -speed-check-mode tcp:80 -nameserver domestic |" apple_china.domains.txt > apple_china.domain.smartdns.conf

    - name: Compile microsoft_china_domains from DustinWin/ruleset_geodata
      run: cd /workdir/dnsmasq-china-list && wget -qO- https://raw.githubusercontent.com/DustinWin/ruleset_geodata/refs/heads/mihomo-ruleset/microsoft-cn.list | sed -E "s/^[[:space:]]*[-+ .]*//; s/['\"]//g; /^[[:space:]]*$/d; /^#/d" | sort -u > microsoft_china.domains.txt && sed -e "s|\(.*\)|domain-rules /\1/ -speed-check-mode tcp:80 -nameserver domestic |" microsoft_china.domains.txt > microsoft_china.domain.smartdns.conf

    - name: Compile chinalist
      run: cd /workdir/dnsmasq-china-list && wget https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/refs/heads/release/china-list.txt -O chinalist.txt && sed -e "s|\(.*\)|domain-rules /\1/ -speed-check-mode tcp:80 -address - -nameserver domestic -ipset china|" chinalist.txt > chinalist.domain.smartdns.conf

    - name: Compile again gfwlist
      run: cd /workdir/dnsmasq-china-list && wget https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/refs/heads/release/gfw.txt -O gfwlist.txt && sed -e "s|\(.*\)|domain-rules /\1/ -speed-check-mode none -nameserver gfw -address \#6|" gfwlist.txt > gfwlist.domain.smartdns.conf
    
    - name: Checkout
      uses: actions/checkout@master
      with:
         token: ${{ secrets.PAT_TOKEN  }}

    - name: Copy files
      run: cp -rf /workdir/dnsmasq-china-list/*.domain.smartdns.conf ./ 
      
    - name: Add & Commit
      uses: EndBug/add-and-commit@v9.1.4
            
    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ github.token }}
        repository: ${{ github.repository }}
        retain_days: 1
        keep_minimum_runs: 2
